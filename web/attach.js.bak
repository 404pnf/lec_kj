 
//附件弹层
var  pop = pop || {};//如果已经加载过pop，则直接赋值对象，否则创建一个新对象。
pop.setting = {
		width: 200,	//弹框的宽
		height: 250,	//弹框的高
		button_position: "LM",	//附件按钮所在的位置信息，LT 左上，LB 左下，RT 右上，RB 右下，LM 左中，RM 右中，TM 上中，BM 下中，按钮的位置决定弹层的位置，但不会修改按钮本身的位置
		pop_x: 10,	//弹框距离按钮的x值。按钮在 LT、LB、LM ，则x代表距按钮右侧的距离；按钮RT、RB、RM、TM、BM，则是距按钮左侧的距离；
		pop_y: 20,	//弹框距离按钮的x值。按钮在 LT、RT、TM ，则y代表距按钮之下的距离；按钮LB、RB、BM、LM、RM，则是距按钮上侧的距离
		pop_center: false, //弹层是否居中，如果值为true，则pop_x,pop_y将不起作用，弹层上下左右居中显示
		display_close_btn: true,
		fn: "",
};

pop.base={
		pop_obj : {},
		pop_property_obj: {},
};

//弹窗的初始化
pop.init = function(pop_property_obj){
	pop.base.pop_property_obj = $(pop_property_obj);	//设置全局的获取属性div对象，必须
	pop.base.pop_obj = pop.until.creat_pop();	//生成全局的弹窗对象，必须
	
	//根据设置，控制弹窗的显示
	if(pop.setting.pop_center){
		pop.until.pop_position_center();
	}
	else{
		pop.until.pop_position_set();
	}
	pop.base.pop_obj.click(function(event){
		event.stopPropagation();
	});
	
	pop.until.close_btn();//给关闭按钮绑定事件，并且控制是否显示
	
	if(pop.setting.fn){
		pop.setting.fn(pop.get.container());
    }

};

//获取元素的方法
pop.get = {
	pop_btn_obj: function(){
		return pop.base.pop_property_obj.find("img.pop_btn");
	},
    title_container:function(){
        return pop.base.pop_obj.find(".title_value");
    },
    container:function(){
        return pop.base.pop_obj.find(".content_container");
    },
	close_button_obj:function(){
        return pop.base.pop_obj.find(".close_button");
    },
    load_image:function(){
        return pop.base.pop_obj.find(".loadimg");
    },
	content:function(){
		
	},
};

pop.until = {
	creat_pop:function(id){
		var	$pop_obj = 
			$('<div id="'+id+'" class="pop_window">'+
				'<div class="left_line"></div>'+
				'<div class="right_line"></div>'+
				'<div class="title_bar">'+
					'<div class="close_button" title="关闭">×</div>'+
					'<div class="title_value">附加资源</div>'+
				'</div>'+
				'<div class="content_container">'+
				'</div>'+
				'<div class="bottom_line">'+
					'<div class="leftcorner"></div>'+
					'<div class="rightcorner"></div>'+
				'</div>'+
			'</div>');
		$pop_obj.css({
			"width":pop.setting.width,
			"max-height":pop.setting.height
		});
		
		return $pop_obj;
	},
	pop_position_center:function(){
		//弹窗居中
		var $container_obj = $("body");
		var $pop_mask = $('<div id="pop_mask"></div>');
		$container_obj.append($pop_mask);

		s_top=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop; 
		w_height = document.documentElement.clientHeight;
	 	var pop_top = s_top+(w_height-pop.setting.height)/2;
	 	
		w_width = document.documentElement.clientWidth;
	 	var pop_left = (w_width-pop.setting.width)/2;
	 	
	 	pop.base.pop_obj.css({
			"top": pop_top,
			"left": pop_left,
			});
	 	pop.base.pop_obj.appendTo($container_obj).fadeIn();
	},
	pop_position_set:function(){
		//根据设置定义弹窗位置
		var $container_obj = pop.base.pop_property_obj;
		$container_obj.css({"position":"relative"});
		
		var btn_pos = pop.setting.button_position;
		var btn_width = pop.get.pop_btn_obj().width();
		var btn_height = pop.get.pop_btn_obj().height();
		var pop_x = pop.setting.pop_x;
		var pop_y = pop.setting.pop_y;
		
		if(btn_pos == "LT"){
			pop.base.pop_obj.css({
				"left": btn_width + pop_x,
				"top": btn_height + pop_y,
			});
		}
		else if(btn_pos == "RT"){
			pop.base.pop_obj.css({
				"right": btn_width + pop_x,
				"top": btn_height + pop_y,
			});
		}
		else if(btn_pos == "LB"){
			pop.base.pop_obj.css({
				"left": btn_width + pop_x,
				"bottom": btn_height + pop_y,
			});
		}
		else if(btn_pos == "RB"){
			pop.base.pop_obj.css({
				"right": btn_width + pop_x,
				"bottom": btn_height + pop_y,
			});
		}
		else if(btn_pos == "LM"){
			pop.base.pop_obj.css({
				"left": btn_width + pop_x,
				"top": -pop_y,
			});
		}
		else if(btn_pos == "RM"){
			pop.base.pop_obj.css({
				"right": btn_width + pop_x,
				"top": -pop_y,
			});
		}
		else if(btn_pos == "TM"){
			pop.base.pop_obj.css({
				"left": -pop_x,
				"top": btn_height + pop_y,
			});
		}
		else if(btn_pos == "BM"){
			pop.base.pop_obj.css({
				"left": -pop_x,
				"bottom": btn_height + pop_y,
			});
		}
		pop.base.pop_obj.appendTo($container_obj).fadeIn();
	},
	close_pop:function(){
		pop.base.pop_obj.remove();
		$("#pop_mask").remove();
	},
	close_btn:function(){
		var $close_btn_obj = pop.get.close_button_obj();
		
		if(!pop.setting.display_close_btn)	$close_btn_obj.css("display","none");
		$close_btn_obj.click(function(event){
			pop.until.close_pop();
		});
	},
    
};


var attach = attach || {};
attach.setting = {
		server: "localhost", //服务器地址
		user_id: 2,	//用户id
		page_uniq_id: "test", //页面唯一标识，有课件名、课号、页号等组成，确保唯一性
		width: 200,	//弹框的宽
		height: 250,	//弹框的高
		button_position: "LM",	//附件按钮所在的位置信息，LT 左上，LB 左下，RT 右上，RB 右下，LM 左中，RM 右中，TM 上中，BM 下中，按钮的位置决定弹层的位置，但不会修改按钮本身的位置
		pop_x: 10,	//弹框距离按钮的x值。按钮在 LT、LB、LM ，则x代表距按钮右侧的距离；按钮RT、RB、RM、TM、BM，则是距按钮左侧的距离；
		pop_y: 20,	//弹框距离按钮的x值。按钮在 LT、RT、TM ，则y代表距按钮之下的距离；按钮LB、RB、BM、LM、RM，则是距按钮上侧的距离
		pop_center: false, //弹层是否居中，如果值为true，则pop_x,pop_y将不起作用，弹层上下左右居中显示
		display_close_btn: true	//是否显示关闭按钮
};

attach.property_obj = {};


//附件初始化
attach.init = function(attach_property_obj){
	attach.property_obj = $(attach_property_obj);	//设置全局的获取属性div对象，必须
	
	attach.until.pop(attach.until.list_pop, attach.until.edit_pop);
 
  //下载页面
  //var url = "/book/content/chapter/"+attach.setting.type+"/"+attach.setting.language+"/"+attach.setting.bookId+"/"+attach.setting.chapterId+"/100000";
  //attach.until.loadPageByChapter(url);
  //绑定翻页功能

};

//获取元素的方法
attach.get = {
	server:function(){
		var server = attach.property_obj.attr("data-server");
		return (server == "" || server == undefined) ? attach.setting.server : server;
	},
	user_id:function(){
		var user_id = +attach.property_obj.attr("data-user_id");
		return (user_id == "" || user_id == undefined) ? attach.setting.user_id : user_id;
	},
	page_uniq_id:function(){
		var lessonid = attach.property_obj.attr("data-lesson_id");
		var pageid = attach.property_obj.attr("data-page_id");
		if(lessonid == "" || lessonid == undefined || pageid == "" || pageid == undefined ){
			alert("加载附件出错");
			return attach.setting.page_uniq_id;
		}
		else{
			var id =  "abc_lesson_"+lessonid+"_page_"+pageid;
			return id;
		}	
	},
	width:function(){
		var width = +attach.property_obj.attr("data-width");
		return (width == "" || width == undefined) ? attach.setting.width : width;
	},
	height:function(){
		var height = +attach.property_obj.attr("data-height");
		return (height == "" || height == undefined) ? attach.setting.height : height;
	},
	button_position:function(){
		var button_position = attach.property_obj.attr("data-button_position");
		return (button_position == "" || button_position == undefined) ? attach.setting.button_position : button_position;
	},
	pop_x:function(){
		var pop_x = +attach.property_obj.attr("data-pop_x");
		return (pop_x == "" || pop_x == undefined) ? attach.setting.pop_x : pop_x;
	},
	pop_y:function(){
		var pop_y = +attach.property_obj.attr("data-pop_y");
		return (pop_y == "" || pop_y == undefined) ? attach.setting.pop_y : pop_y;
	},
	pop_center:function(){
		var pop_center = attach.property_obj.attr("data-pop_center");
		if(pop_center == "true")	pop_center = true;
		else if(pop_center == "false")	pop_center = false;
		return (pop_center == "" || pop_center == undefined) ? attach.setting.pop_center : pop_center;
	},
	display_close_btn:function(){
		var display_close_btn = attach.property_obj.attr("data-close_btn");
		if(display_close_btn == "true")	display_close_btn = true;
		else if(display_close_btn == "false")	display_close_btn = false;
		return (display_close_btn === "" || display_close_btn == undefined) ? attach.setting.display_close_btn : display_close_btn;
	},
};

attach.until = {
	pop: function(list_pop, edit_pop){
			var url = "http://"+attach.get.server()+"/kejian/attach.php";
			var postdata = {"f":"list",
					"user_id":attach.get.user_id(),
					"page_id":attach.get.page_uniq_id()};
			console.log(postdata);
			$.getJSON(url, postdata, function(data){
				var status = data.status;
				var info = data.info;
				if(status!=1){
					alert(data.message);
				}
				else{
					if(info.length==0){
						edit_pop();//没有资源列表，显示添加内容窗口
					}
					else{
						list_pop(info);//显示资源列表
					}
				}
			});
	},
	list_pop: function(list_info){
		//设置弹层的属性，并且初始化
		pop.setting.width = attach.get.width();
		pop.setting.height = attach.get.height();
		pop.setting.button_position = attach.get.button_position();
		pop.setting.pop_x = attach.get.pop_x();
		pop.setting.pop_y = attach.get.pop_y();
		pop.setting.pop_center = attach.get.pop_center();
		pop.setting.display_close_btn = attach.get.display_close_btn();
		pop.setting.fn = function(content_con){
			attach.until.list(content_con, list_info);
		};
		pop.init(attach.property_obj);
	
	},
	list: function(content_con, list_info){
		var html = '<ul class="simple_list">';
		$.each(list_info,function(index, data){
			//"id":"2","user_id":"1","page_id":"abc_page_1","resource_tip":"aaa.com","resource_link":"aaa.com","link_type":"1","create_time":"2013-09-11 19:09:21"
			var resource_link = data.resource_link;
			if(resource_link.search(/\:/)==-1)
				resource_link = "http://"+resource_link;
			html += '<li><a href="'+resource_link+'">'+data.resource_tip+'</a></li>';
		});
			html +='</ul>';
			html +='<a class="edit_btn" href="javascript:void(0)"></a>';
		content_con.html(html);
		
		$(".edit_btn").click(function(){//点编辑按钮，出大弹层
			pop.until.close_pop();
			attach.until.edit_pop(list_info);
		});
	},
	edit_pop: function(list_info){
		//设置弹层的属性，并且初始化
		pop.setting.width = attach.get.width()*2;
		pop.setting.height = attach.get.height();
		pop.setting.button_position = attach.get.button_position();
		pop.setting.pop_x = attach.get.pop_x();
		pop.setting.pop_y = attach.get.pop_y();
		pop.setting.pop_center = attach.get.pop_center();
		pop.setting.display_close_btn = attach.get.display_close_btn();
		pop.setting.fn = function(content_con){
			attach.until.edit_list(content_con, list_info);
		};
		pop.init(attach.property_obj);
	
	},
	edit_list: function(content_con, list_info){
//		title_con.html("这是标题");
//		content_con.html("这是内容");
		console.log("list:");
		console.log(list_info);
		var html = '<ul class="simple_list">';
		$.each(list_info,function(index, data){
			//"id":"2","user_id":"1","page_id":"abc_page_1","resource_tip":"aaa.com","resource_link":"aaa.com","link_type":"1","create_time":"2013-09-11 19:09:21"
			var resource_link = data.resource_link;
			if(resource_link.search(/\:/)==-1)
				resource_link = "http://"+resource_link;
			html += '<li><a href="'+resource_link+'">'+data.resource_tip+'</a></li>';
		});
			html +="</ul>";
			
		content_con.html(html);
	}
};